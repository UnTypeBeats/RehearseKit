<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Test - RehearseKit</title>
    <style>
        body { font-family: system-ui; max-width: 800px; margin: 50px auto; padding: 20px; }
        .log { background: #f5f5f5; padding: 15px; border-radius: 8px; max-height: 400px; overflow-y: auto; }
        .log-entry { padding: 5px 0; border-bottom: 1px solid #ddd; }
        .success { color: #10B981; }
        .error { color: #EF4444; }
        button { padding: 10px 20px; margin: 10px 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>ðŸŽµ RehearseKit WebSocket Test</h1>
    
    <div>
        <button onclick="createJob()">Create Test Job</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>
    
    <div id="status" style="margin: 20px 0; font-weight: bold;"></div>
    <div class="log" id="log"></div>

    <script>
        let ws = null;
        let currentJobId = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + (type === 'error' ? 'error' : type === 'success' ? 'success' : '');
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function updateStatus(text) {
            document.getElementById('status').textContent = text;
        }

        async function createJob() {
            log('Creating test job via API...');
            
            const formData = new FormData();
            formData.append('project_name', 'WebSocket Test');
            formData.append('quality_mode', 'fast');
            formData.append('input_url', 'https://www.youtube.com/watch?v=jNQXAC9IVRw');
            
            try {
                const response = await fetch('http://localhost:8000/api/jobs/create', {
                    method: 'POST',
                    body: formData
                });
                
                const job = await response.json();
                currentJobId = job.id;
                log(`âœ… Job created: ${job.id}`, 'success');
                log(`Project: ${job.project_name}`);
                
                connectWebSocket(job.id);
            } catch (error) {
                log(`âŒ Error creating job: ${error}`, 'error');
            }
        }

        function connectWebSocket(jobId) {
            log(`Connecting to WebSocket for job ${jobId}...`);
            
            ws = new WebSocket(`ws://localhost:8001/jobs/${jobId}/progress`);
            
            ws.onopen = () => {
                log('âœ… WebSocket connected!', 'success');
                updateStatus('ðŸ”´ LIVE - Waiting for updates...');
            };
            
            ws.onmessage = (event) => {
                const update = JSON.parse(event.data);
                log(`ðŸ“Š Progress Update: ${update.status} - ${update.progress_percent}%`, 'success');
                updateStatus(`Status: ${update.status} (${update.progress_percent}%)`);
                
                if (update.status === 'COMPLETED' || update.status === 'FAILED') {
                    log(`ðŸŽ‰ Job ${update.status}!`, 'success');
                    ws.close();
                }
            };
            
            ws.onerror = (error) => {
                log(`âŒ WebSocket error: ${error}`, 'error');
            };
            
            ws.onclose = () => {
                log('WebSocket closed');
                updateStatus('Disconnected');
            };
        }
    </script>
</body>
</html>

